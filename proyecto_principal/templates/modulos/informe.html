{% extends "dashboard/layout.html" %}

{% block content %}

<div class="container mt-4">
    <div class="card shadow mb-4">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(90deg, #ff6b6b, #ffa500);">
            <h4 class="mb-0">Consulta de Reportes</h4>
        </div>

        <div class="card-body">

            <!-- Selección de tipo -->
            <div class="mb-5">
                <label class="form-label fw-bold d-block mb-3 text-center fs-5">¿Qué deseas consultar?</label>

                <div class="d-flex flex-wrap justify-content-center gap-4">
                    <button type="button" class="btn btn-outline-primary btn-lg tipo-btn shadow-sm {% if tipo_actual == 'ventas' or not tipo_actual %}active{% endif %}" data-tipo="ventas">
                        <i class="bi bi-cart-check-fill fs-1 d-block mb-2"></i> Ventas
                    </button>

                    <button type="button" class="btn btn-outline-success btn-lg tipo-btn shadow-sm {% if tipo_actual == 'compras' %}active{% endif %}" data-tipo="compras">
                        <i class="bi bi-bag-fill fs-1 d-block mb-2"></i> Compras
                    </button>

                    <button type="button" class="btn btn-outline-info btn-lg tipo-btn shadow-sm {% if tipo_actual == 'pedidos' %}active{% endif %}" data-tipo="pedidos">
                        <i class="bi bi-list-check fs-1 d-block mb-2"></i> Pedidos
                    </button>

                    <button type="button" class="btn btn-outline-warning btn-lg tipo-btn shadow-sm {% if tipo_actual == 'inventario' %}active{% endif %}" data-tipo="inventario">
                        <i class="bi bi-box-seam-fill fs-1 d-block mb-2"></i> Inventario
                    </button>
                </div>
            </div>

            <!-- Fechas -->
            <form method="get" class="row g-3 align-items-end mb-4" id="filtro-form">
                <input type="hidden" name="tipo" id="tipo-hidden" value="{{ tipo_actual|default:'ventas' }}">

                <div class="col-md-4">
                    <label class="form-label fw-bold">Fecha de inicio</label>
                    <input type="date" name="fecha_inicio" class="form-control" value="{{ fecha_inicio|default:'' }}" required>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold">Fecha de fin</label>
                    <input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin|default:'' }}" required>
                </div>

                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100 mt-4">
                        <i class="bi bi-search"></i> Consultar
                    </button>
                </div>
            </form>

            <!-- Mensaje -->
            <div class="alert alert-info mt-3">
                {{ mensaje }}
            </div>

            <!-- Ventas -->
            {% if tipo_actual == 'ventas' and resultados %}
            <div class="table-responsive mt-4">
                <h5>Ventas encontradas ({{ cantidad }})</h5>
                <table class="table table-bordered table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th>Fecha</th>
                            <th>Pedido</th>
                            <th class="text-end">Total</th>
                            <th>Método</th>
                            <th>Estado</th>
                            <th>Admin</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in resultados %}
                        <tr>
                            <td>{{ v.fecha|date:"d/m/Y" }}</td>
                            <td>{{ v.pedido.id }}</td>
                            <td class="text-end">${{ v.total|floatformat:2 }}</td>
                            <td>{{ v.get_metodo_pago_display }}</td>
                            <td>{{ v.get_estado_display }}</td>
                            <td>{{ v.admin|default:"—" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center">No hay ventas en este rango</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-success fw-bold">
                        <tr>
                            <td colspan="2">TOTAL</td>
                            <td class="text-end">${{ total|floatformat:2 }}</td>
                            <td colspan="3">{{ cantidad }} ventas</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% endif %}

            <!-- Compras -->
            {% if tipo_actual == 'compras' and resultados %}
            <div class="table-responsive mt-4">
                <h5>Compras encontradas ({{ cantidad }})</h5>
                <table class="table table-bordered table-hover">
                    <thead class="table-success">
                        <tr>
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th class="text-end">Cantidad</th>
                            <th class="text-end">Precio unit.</th>
                            <th class="text-end">Subtotal</th>
                            <th>Proveedor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in resultados %}
                        <tr>
                            <td>{{ c.fecha|date:"d/m/Y" }}</td>
                            <td>{{ c.producto.nombre|default:c.producto|default:"—" }}</td>
                            <td class="text-end">{{ c.cantidad }}</td>
                            <td class="text-end">${{ c.precio|floatformat:2 }}</td>
                            <td class="text-end fw-bold">${{ c.subtotal|floatformat:2 }}</td>
                            <td>{{ c.proveedor.nombre|default:c.proveedor|default:"—" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center">No hay compras en este rango</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-active fw-bold">
                        <tr>
                            <td colspan="4">TOTAL</td>
                            <td class="text-end">${{ total|floatformat:2 }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% endif %}

            <!-- Pedidos -->
            {% if tipo_actual == 'pedidos' and resultados %}
            <div class="table-responsive mt-4">
                <h5>Pedidos encontrados ({{ cantidad }})</h5>
                <table class="table table-bordered table-hover">
                    <thead class="table-info">
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Mesa</th>
                            <th class="text-end">Total</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in resultados %}
                        <tr>
                            <td>#{{ p.id }}</td>
                            <td>{{ p.fecha|date:"d/m/Y H:i" }}</td>
                            <td>{{ p.mesa }}</td>
                            <td class="text-end">${{ p.total_calculado|floatformat:2 }}</td>
                            <td>{{ p.get_estado_display }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center">No hay pedidos en este rango</td></tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-active fw-bold">
                        <tr>
                            <td colspan="3">TOTAL</td>
                            <td class="text-end">${{ total|floatformat:2 }}</td>
                            <td>{{ cantidad }} pedidos</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% endif %}

            <!-- Inventario -->
            {% if tipo_actual == 'inventario' and resultados %}
            <div class="table-responsive mt-4">
                <h5>Registros diarios ({{ cantidad }})</h5>
                <table class="table table-bordered table-hover">
                    <thead class="table-warning">
                        <tr>
                            <th>Fecha</th>
                            <th>Apertura</th>
                            <th>Cierre</th>
                            <th>Estado</th>
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in resultados %}
                        <tr>
                            <td>{{ i.fecha|date:"d/m/Y" }}</td>
                            <td>{{ i.fecha_apertura|date:"d/m/Y H:i"|default:"—" }}</td>
                            <td>{{ i.fecha_cierre|date:"d/m/Y H:i"|default:"—" }}</td>
                            <td>{{ i.get_estado_display }}</td>
                            <td>{{ i.observaciones|default:"—"|truncatewords:10 }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center">No hay registros diarios en este rango</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <!-- Menú -->
            {% if tipo_actual == 'menu' %}
            <div class="mt-4">
                <h5>Productos del menú actual ({{ cantidad }})</h5>
                <ul class="list-group">
                    {% for m in resultados %}
                    <li class="list-group-item">
                        <strong>{{ m.nombre }}</strong>
                        {% if m.descripcion %}<br><small class="text-muted">{{ m.descripcion|truncatewords:20 }}</small>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const botones = document.querySelectorAll('.tipo-btn');
    const inputTipoHidden = document.getElementById('tipo-hidden');
    const formFiltro = document.getElementById('filtro-form');

    botones.forEach(boton => {
        boton.addEventListener('click', () => {
            // Remover clase active de todos los botones
            botones.forEach(b => b.classList.remove('active'));

            // Agregar clase active al botón clickeado
            boton.classList.add('active');

            // Actualizar el valor del campo oculto
            const tipoSeleccionado = boton.dataset.tipo;
            inputTipoHidden.value = tipoSeleccionado;

            // Si hay fechas seleccionadas, enviar el formulario
            const fi = document.querySelector('[name="fecha_inicio"]').value;
            const ff = document.querySelector('[name="fecha_fin"]').value;
            if (fi && ff) {
                formFiltro.submit();
            }
        });
    });
});
</script>

{% endblock %}