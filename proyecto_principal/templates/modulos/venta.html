{% extends "dashboard/layout.html" %}
{% block content %}
<div class="mb-3">
    <button id="btnPendientes" class="btn btn-warning btn-sm">
        Pendientes
    </button>
    <button id="btnPagadas" class="btn btn-success btn-sm">
        Finalizadas
    </button>
    <button id="btnTodas" class="btn btn-secondary btn-sm">
        Todas
    </button>
</div>

<table id="tablaVentas" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Factura</th>
            <th>Pedido</th>
            <th>Cliente</th>
            <th>Mesa/llevar</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for v in ventas %}
        <tr>
            <td>{{ v.numero_factura }}</td>
            <td>#{{ v.pedido.numero_pedido }}</td>
            <td>{{ v.pedido.cliente_nombre }}</td>
            <td>
    {% if v.mesa %}
        Mesa {{ v.mesa.numero }}
    {% else %}
        Para llevar
    {% endif %}
</td>



            <td>{{ v.fecha_venta|date:"d/m/Y H:i" }}</td>
            <td class="text-end fw-bold">$ {{ v.total }}</td>
            <td data-estado="{{ v.estado }}">
    {% if v.estado == 'pendiente' %}
        <span class="badge bg-warning">Pendiente</span>
    {% else %}
        <span class="badge bg-success">Pagado</span>
    {% endif %}
</td>

            <td class="text-center">

                {% if v.estado == 'pendiente' %}
                <form method="post" action="{% url 'apl:venta:venta_finalizar' v.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <button class="btn btn-success btn-sm">
                        Finalizar
                    </button>
                </form>
                {% endif %}

                <a href="{% url 'apl:venta:venta_detail' v.pk %}"
                   class="btn btn-outline-primary btn-sm">
                    Ver
                </a>

                {% if v.estado == 'pagado' %}
                <a href="{% url 'apl:venta:factura' v.pk %}"
                   class="btn btn-outline-dark btn-sm">
                    Factura
                </a>
                {% endif %}

            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% block js_init %}
<script>
$(document).ready(function() {

    var table = $('#tablaVentas').DataTable({
        language: {
            lengthMenu: "Mostrar _MENU_ registros por página",
            zeroRecords: "No se encontraron resultados",
            info: "Mostrando página _PAGE_ de _PAGES_",
            infoEmpty: "No hay registros disponibles",
            infoFiltered: "(filtrado de _MAX_ registros totales)",
            search: "Buscar:",
            paginate: {
                first: "Primero",
                last: "Último",
                next: "Siguiente",
                previous: "Anterior"
            }
        },
        order: [[4, "desc"]],
        pageLength: 10
    });

    // Filtro personalizado por estado usando data-estado
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {

        var filtroActivo = $('#tablaVentas').data('filtro') || 'pendiente';
        var estado = table.row(dataIndex).node().querySelector('td[data-estado]').getAttribute('data-estado');

        if (filtroActivo === 'todas') return true;
        return estado === filtroActivo;
    });

    // Filtro por defecto: pendientes
    $('#tablaVentas').data('filtro', 'pendiente');
    table.draw();

    $('#btnPendientes').on('click', function() {
        $('#tablaVentas').data('filtro', 'pendiente');
        table.draw();
    });

    $('#btnPagadas').on('click', function() {
        $('#tablaVentas').data('filtro', 'pagado');
        table.draw();
    });

    $('#btnTodas').on('click', function() {
        $('#tablaVentas').data('filtro', 'todas');
        table.draw();
    });

});

</script>

{% endblock %}



{% endblock %}
