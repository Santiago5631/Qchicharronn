{% extends "dashboard/layout.html" %}

{% block content %}
{% comment %}
  GUARDAR EN: menu/templates/menu/vista_cocina.html
{% endcomment %}
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vista {{ area_display }}</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    {% if area == 'parrilla' %}
    --accent:     #f97316;
    --accent2:    #fb923c;
    --bg:         #1a0a00;
    --bg2:        #2d1200;
    --header-bg:  #7c2d12;
    --header-border: #f97316;
    --card-bg:    rgba(249,115,22,0.07);
    --card-border:rgba(249,115,22,0.18);
    --text:       #fef3c7;
    --text-muted: rgba(254,243,199,0.5);
    --icon:       üî•;
    {% else %}
    --accent:     #06b6d4;
    --accent2:    #22d3ee;
    --bg:         #001a20;
    --bg2:        #002d3d;
    --header-bg:  #0e4d5c;
    --header-border: #06b6d4;
    --card-bg:    rgba(6,182,212,0.07);
    --card-border:rgba(6,182,212,0.18);
    --text:       #e0f7fa;
    --text-muted: rgba(224,247,250,0.5);
    {% endif %}
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: linear-gradient(135deg, var(--bg) 0%, var(--bg2) 60%, var(--bg) 100%);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  /* ---- HEADER ---- */
  .header {
    background: var(--header-bg);
    border-bottom: 3px solid var(--header-border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 14px;
    position: sticky; top: 0; z-index: 100;
  }
  .header-icon { font-size: 34px; }
  .header-title {
    font-family: 'Playfair Display', serif;
    font-size: 26px; font-weight: 900; letter-spacing: 1px;
  }
  .header-sub {
    font-size: 11px; color: var(--accent2);
    letter-spacing: 3px; text-transform: uppercase; margin-top: 2px;
  }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
  .status-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: #22c55e; box-shadow: 0 0 8px #22c55e;
  }
  .status-dot.offline { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
  .ws-label { font-size: 11px; color: var(--text-muted); }

  /* ---- FILTRO CATEGOR√çAS ---- */
  .filtro-section {
    padding: 14px 24px;
    background: rgba(0,0,0,0.25);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .filtro-label {
    font-size: 11px; color: var(--text-muted);
    letter-spacing: 2px; text-transform: uppercase; white-space: nowrap;
  }
  .filtro-tags { display: flex; flex-wrap: wrap; gap: 8px; }
  .cat-tag {
    padding: 6px 14px; border-radius: 20px; border: none; cursor: pointer;
    font-size: 12px; font-weight: 700; font-family: 'DM Sans', sans-serif;
    background: rgba(255,255,255,0.07);
    color: rgba(255,255,255,0.4);
    transition: all 0.2s;
  }
  .cat-tag.active {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 0 12px color-mix(in srgb, var(--accent) 60%, transparent);
  }

  /* ---- BOARD DE PEDIDOS ---- */
  .pedidos-board {
    padding: 20px 24px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 16px;
    align-items: start;
  }

  .empty-state {
    grid-column: 1/-1;
    text-align: center; padding: 60px 20px;
    color: var(--text-muted); font-size: 14px;
  }
  .empty-state .emoji { font-size: 48px; margin-bottom: 12px; }

  /* ---- TARJETA PEDIDO ---- */
  .pedido-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 14px; overflow: hidden;
    animation: slideIn 0.35s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .pedido-card.nuevo {
    animation: pulseNew 0.6s ease;
  }
  @keyframes pulseNew {
    0%  { box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 70%, transparent); }
    60% { box-shadow: 0 0 0 12px transparent; }
    100%{ box-shadow: none; }
  }

  .pedido-head {
    background: rgba(0,0,0,0.3);
    padding: 12px 16px;
    display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
  }
  .pedido-numero {
    font-family: 'Playfair Display', serif;
    font-size: 17px; font-weight: 900; color: var(--accent);
  }
  .pedido-mesa {
    font-size: 12px; color: var(--text-muted); margin-top: 2px;
  }
  .pedido-hora {
    font-size: 11px; color: var(--text-muted);
    background: rgba(255,255,255,0.06);
    padding: 3px 8px; border-radius: 10px; white-space: nowrap;
  }

  .pedido-info {
    padding: 8px 16px;
    font-size: 12px; color: var(--text-muted);
    display: flex; gap: 14px; flex-wrap: wrap;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .pedido-info span { display: flex; align-items: center; gap: 4px; }

  .pedido-items { padding: 12px 16px; display: flex; flex-direction: column; gap: 8px; }

  .item-row {
    display: flex; align-items: flex-start; gap: 10px;
  }
  .item-qty {
    min-width: 32px; height: 32px; border-radius: 8px;
    background: var(--accent); color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 14px; flex-shrink: 0;
  }
  .item-body { flex: 1; }
  .item-nombre { font-weight: 700; font-size: 14px; color: var(--text); line-height: 1.3; }
  .item-cat {
    font-size: 10px; color: var(--accent2);
    text-transform: uppercase; letter-spacing: 1px; margin-top: 2px;
  }
  .item-obs {
    font-size: 11px; color: #fbbf24;
    margin-top: 3px; font-style: italic;
  }

  .pedido-obs-global {
    padding: 8px 16px 12px;
    font-size: 11px; color: #fbbf24;
    font-style: italic;
  }

  /* Estado badge */
  .estado-badge {
    padding: 3px 9px; border-radius: 20px;
    font-size: 10px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;
    flex-shrink: 0;
  }
  .estado-pendiente  { background: #854d0e; color: #fef08a; }
  .estado-preparando { background: #1e40af; color: #bfdbfe; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-icon">{% if area == 'parrilla' %}üî•{% else %}üç≤{% endif %}</div>
  <div>
    <div class="header-title">{{ area_display|upper }}</div>
    <div class="header-sub">Vista de Cocina ¬∑ Pedidos en vivo</div>
  </div>
  <div class="header-right">
    <span class="ws-label" id="ws-label">Conectando...</span>
    <div class="status-dot offline" id="status-dot"></div>
  </div>
</div>

<!-- FILTRO CATEGOR√çAS -->
<div class="filtro-section">
  <span class="filtro-label">Ver categor√≠as:</span>
  <div class="filtro-tags" id="filtro-tags">
    {% for cat in todas_categorias %}
    <button
      class="cat-tag {% if cat.id in categorias_activas_ids %}active{% endif %}"
      data-id="{{ cat.id }}"
      onclick="toggleCategoria(this)"
    >{{ cat.nombre }}</button>
    {% endfor %}
  </div>
</div>

<!-- BOARD DE PEDIDOS -->
<div class="pedidos-board" id="pedidos-board">
  {% if pedidos %}
    {% for item in pedidos %}
    {% with p=item.pedido its=item.items %}
    <div class="pedido-card" id="pedido-{{ p.numero_pedido }}">
      <div class="pedido-head">
        <div>
          <div class="pedido-numero">#{{ p.numero_pedido }}</div>
          <div class="pedido-mesa">
            {% if p.mesa %}ü™ë {{ p.mesa }}{% else %}üõç Para llevar{% endif %}
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
          <span class="pedido-hora">{{ p.fecha_creacion|time:"H:i" }}</span>
          <span class="estado-badge estado-{{ p.estado }}">{{ p.get_estado_display }}</span>
        </div>
      </div>
      <div class="pedido-info">
        <span>üë§ {{ p.mesero.get_full_name|default:"Sin mesero" }}</span>
        <span>üçΩ {{ its|length }} item(s)</span>
      </div>
      <div class="pedido-items">
        {% for it in its %}
        <div class="item-row">
          <div class="item-qty">{{ it.cantidad }}</div>
          <div class="item-body">
            <div class="item-nombre">{{ it.menu.nombre }}</div>
            {% if it.menu.categoria_menu %}
            <div class="item-cat">{{ it.menu.categoria_menu.nombre }}</div>
            {% endif %}
            {% if it.observaciones %}
            <div class="item-obs">üìù {{ it.observaciones }}</div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% if p.observaciones %}
      <div class="pedido-obs-global">üìã {{ p.observaciones }}</div>
      {% endif %}
    </div>
    {% endwith %}
    {% endfor %}
  {% else %}
  <div class="empty-state" id="empty-state">
    <div class="emoji">{% if area == 'parrilla' %}üî•{% else %}üç≤{% endif %}</div>
    <div>Sin pedidos activos en este momento</div>
  </div>
  {% endif %}
</div>

<script>
const AREA = "{{ area }}";
const WS_URL = `ws://${window.location.host}/ws/vista/${AREA}/`;

let categoriasActivas = new Set({{ categorias_activas_ids|safe }});
let socket;
let reconnectTimer;

function conectar() {
  socket = new WebSocket(WS_URL);

  socket.onopen = () => {
    document.getElementById('status-dot').classList.remove('offline');
    document.getElementById('ws-label').textContent = 'En vivo';
  };

  socket.onclose = () => {
    document.getElementById('status-dot').classList.add('offline');
    document.getElementById('ws-label').textContent = 'Reconectando...';
    reconnectTimer = setTimeout(conectar, 3000);
  };

  socket.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.type === 'config_inicial') {
      // Sync categor√≠as activas desde DB
      categoriasActivas = new Set(data.categorias_activas.map(c => c.id));
    }

    if (data.type === 'pedido_update') {
      manejarPedido(data.pedido, data.accion);
    }
  };
}

function manejarPedido(pedido, accion) {
  // Filtrar items del pedido que tengan categor√≠a activa
  const itemsFiltrados = pedido.items.filter(
    i => i.categoria_id && categoriasActivas.has(i.categoria_id)
  );

  if (itemsFiltrados.length === 0) return; // No aplica para esta vista

  if (['entregado', 'cancelado'].includes(pedido.estado)) {
    // Remover tarjeta si el pedido ya no est√° activo
    const card = document.getElementById(`pedido-${pedido.numero_pedido}`);
    if (card) card.remove();
    checkEmpty();
    return;
  }

  const existente = document.getElementById(`pedido-${pedido.numero_pedido}`);
  if (existente) {
    // Actualizar tarjeta existente
    existente.replaceWith(crearCard(pedido, itemsFiltrados));
  } else {
    // Agregar nueva tarjeta
    const empty = document.getElementById('empty-state');
    if (empty) empty.remove();
    const board = document.getElementById('pedidos-board');
    const card = crearCard(pedido, itemsFiltrados);
    card.classList.add('nuevo');
    board.insertBefore(card, board.firstChild);
    // Sonido de notificaci√≥n
    try { new Audio('/static/sounds/beep.mp3').play(); } catch(e){}
  }
}

function crearCard(pedido, items) {
  const div = document.createElement('div');
  div.className = 'pedido-card';
  div.id = `pedido-${pedido.numero_pedido}`;

  const estadoBadge = pedido.estado === 'pendiente'
    ? '<span class="estado-badge estado-pendiente">Pendiente</span>'
    : '<span class="estado-badge estado-preparando">Preparando</span>';

  const itemsHTML = items.map(i => `
    <div class="item-row">
      <div class="item-qty">${i.cantidad}</div>
      <div class="item-body">
        <div class="item-nombre">${i.nombre}</div>
        ${i.categoria ? `<div class="item-cat">${i.categoria}</div>` : ''}
        ${i.observaciones ? `<div class="item-obs">üìù ${i.observaciones}</div>` : ''}
      </div>
    </div>
  `).join('');

  div.innerHTML = `
    <div class="pedido-head">
      <div>
        <div class="pedido-numero">#${pedido.numero_pedido}</div>
        <div class="pedido-mesa">${pedido.mesa === 'Para llevar' ? 'üõç Para llevar' : 'ü™ë ' + pedido.mesa}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <span class="pedido-hora">${pedido.hora}</span>
        ${estadoBadge}
      </div>
    </div>
    <div class="pedido-info">
      <span>üë§ ${pedido.mesero}</span>
      <span>üçΩ ${items.length} item(s)</span>
    </div>
    <div class="pedido-items">${itemsHTML}</div>
    ${pedido.observaciones ? `<div class="pedido-obs-global">üìã ${pedido.observaciones}</div>` : ''}
  `;
  return div;
}

function toggleCategoria(btn) {
  const id = parseInt(btn.dataset.id);
  if (categoriasActivas.has(id)) {
    if (categoriasActivas.size === 1) return; // M√≠nimo 1 activa
    categoriasActivas.delete(id);
    btn.classList.remove('active');
  } else {
    categoriasActivas.add(id);
    btn.classList.add('active');
  }
  // Guardar en DB via WebSocket
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      action: 'actualizar_categorias',
      categoria_ids: [...categoriasActivas],
    }));
  }
}

function checkEmpty() {
  const board = document.getElementById('pedidos-board');
  if (board.querySelectorAll('.pedido-card').length === 0) {
    const div = document.createElement('div');
    div.id = 'empty-state';
    div.className = 'empty-state';
    div.innerHTML = `
      <div class="emoji">${AREA === 'parrilla' ? 'üî•' : 'üç≤'}</div>
      <div>Sin pedidos activos en este momento</div>
    `;
    board.appendChild(div);
  }
}

// Iniciar conexi√≥n
conectar();
</script>
</body>
</html>
{% endblock %}