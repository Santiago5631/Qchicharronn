<!--- formulario_crear_producto.html-->
{% extends 'dashboard/layout.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'lib/css/forms.css' %}">
<link rel="stylesheet" href="{% static 'lib/css/custom.css' %}">
<!-- Select2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">

<div class="form-container">
    {{ titulo }}
    
    <!-- Contenedor para mensajes -->
    <div id="messages-container">
        {% if messages %}
            {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
    </div>
    
    <form method="post" enctype="multipart/form-data" id="formProducto">
        {% csrf_token %}
        
        <!-- Campo Nombre -->
        <p>
            <label for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }}:</label>
            {{ form.nombre }}
        </p>
        
        <!-- Campo Marca con botón -->
        <div class="field-with-button">
            <div>
                <label for="{{ form.marca.id_for_label }}">{{ form.marca.label }}:</label>
                {{ form.marca }}
            </div>
            <button type="button" class="create-button" onclick="abrirModal('modalMarca')">+ Nueva</button>
        </div>
        
        <!-- Campo Categoría con botón -->
        <div class="field-with-button">
            <div>
                <label for="{{ form.categoria.id_for_label }}">{{ form.categoria.label }}:</label>
                {{ form.categoria }}
            </div>
            <button type="button" class="create-button" onclick="abrirModal('modalCategoria')">+ Nueva</button>
        </div>
        
        <!-- Campo Proveedor con botón -->
        <div class="field-with-button">
            <div>
                <label for="{{ form.proveedor.id_for_label }}">{{ form.proveedor.label }}:</label>
                {{ form.proveedor }}
            </div>
            <button type="button" class="create-button" onclick="abrirModal('modalProveedor')">+ Nuevo</button>
        </div>
        
        <!-- Campo Tipo de Uso -->
        <p>
            <label for="{{ form.tipo_uso.id_for_label }}">{{ form.tipo_uso.label }}:</label>
            {{ form.tipo_uso }}
        </p>
        
        <!-- Campo Unidad con botón -->
        <div class="field-with-button">
            <div>
                <label for="{{ form.unidad.id_for_label }}">{{ form.unidad.label }}:</label>
                {{ form.unidad }}
            </div>
            <button type="button" class="create-button" onclick="abrirModal('modalUnidad')">+ Nueva</button>
        </div>
        
        <!-- Campo Stock -->
        <p>
            <label for="{{ form.stock.id_for_label }}">{{ form.stock.label }}:</label>
            {{ form.stock }}
        </p>

        {% if formset %}
        {{ formset.management_form }}
        {% endif %}

        <div class="formset-container">
            {% for form in formset %}
                <div class="formset-form">
                    {{ form.as_p }}
                </div>
            {% endfor %}
        </div>
        
        <button type="submit">Crear Producto</button>

        {% block extra %}{% endblock %}
    </form>
    
    <div class="back-link">
        <button type="button" onclick="window.history.back();">Volver</button>
    </div>
</div>

<!-- ===== MODALES ===== -->
<div id="modalMarca" class="simple-modal">
    <div class="modal-content">
        <h3>Crear Nueva Marca</h3>
        <form method="post" action="">
            {% csrf_token %}
            
            <label for="nombreMarca">Nombre: *</label>
            <input type="text" id="nombreMarca" name="nombre" placeholder="Ej: Nike, Adidas" required>
            
            <label for="paisOrigenMarca">País de Origen: *</label>
            <input type="text" id="paisOrigenMarca" name="pais_origen" placeholder="Ej: Estados Unidos, Colombia" required>
            
            <label for="descripcionMarca">Descripción:</label>
            <textarea id="descripcionMarca" name="descripcion" rows="3" placeholder="Descripción opcional de la marca"></textarea>
            
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalMarca')">Cancelar</button>
                <button type="submit" name="crear_marca" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalCategoria" class="simple-modal">
    <div class="modal-content">
        <h3>Crear Nueva Categoría</h3>
        <form method="post" action="">
            {% csrf_token %}
            
            <label for="nombreCategoria">Nombre: *</label>
            <input type="text" id="nombreCategoria" name="nombre" placeholder="Ej: Bebidas, Carnes, Condimentos" required>
            
            <label for="descripcionCategoria">Descripción:</label>
            <textarea id="descripcionCategoria" name="descripcion" rows="3" placeholder="Descripción opcional de la categoría"></textarea>
            
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalCategoria')">Cancelar</button>
                <button type="submit" name="crear_categoria" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalProveedor" class="simple-modal">
    <div class="modal-content">
        <h3>Crear Nuevo Proveedor</h3>
        <form method="post" action="">
            {% csrf_token %}
            
            <label for="nombreProveedor">Nombre: *</label>
            <input type="text" id="nombreProveedor" name="nombre" placeholder="Nombre del proveedor" required>
            
            <label for="nitProveedor">NIT: *</label>
            <input type="text" id="nitProveedor" name="nit" placeholder="123456789-0" required>
            
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalProveedor')">Cancelar</button>
                <button type="submit" name="crear_proveedor" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalUnidad" class="simple-modal">
    <div class="modal-content">
        <h3>Crear Nueva Unidad</h3>
        <form method="post" action="">
            {% csrf_token %}
            
            <label for="nombreUnidad">Nombre: *</label>
            <input type="text" id="nombreUnidad" name="nombre" placeholder="Ej: Kilogramos, Litros, Unidades" required>
            
            <label for="descripcionUnidad">Descripción:</label>
            <input type="text" id="descripcionUnidad" name="descripcion" placeholder="Descripción opcional">
            
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cerrarModal('modalUnidad')">Cancelar</button>
                <button type="submit" name="crear_unidad" class="btn-save">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- ===== JAVASCRIPT ===== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar Select2
    $('#id_marca, #id_categoria, #id_proveedor, #id_unidad').select2({
        width: '100%',
        allowClear: true,
        placeholder: 'Seleccione una opción'
    });

    // --- AJAX para cada modal ---
    function enviarAjax(formSelector, url, selectSelector, modalId) {
        $(formSelector).on('submit', function(e) {
            e.preventDefault();

            const formData = {};
            $(this).serializeArray().forEach(item => {
                formData[item.name] = item.value;
            });

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                success: function(response) {
                    if (response.success) {
                        // Agregar nueva opción al select y seleccionarla
                        const newOption = new Option(response.text, response.id, true, true);
                        $(selectSelector).append(newOption).trigger('change');

                        mostrarMensaje('success', 'Registro creado exitosamente');
                        cerrarModal(modalId);
                    } else {
                        mostrarMensaje('error', response.error || 'Error desconocido');
                    }
                },
                error: function() {
                    mostrarMensaje('error', 'Error de conexión con el servidor');
                }
            });
        });
    }

    // Inicializar AJAX para cada formulario de modal
    enviarAjax('#modalMarca form', '{% url "apl:producto:crear_marca_ajax" %}', '#id_marca', 'modalMarca');
    enviarAjax('#modalCategoria form', '{% url "apl:producto:crear_marca_ajax" %}', '#id_categoria', 'modalCategoria');
    enviarAjax('#modalProveedor form', '{% url "apl:producto:crear_proveedor_ajax" %}', '#id_proveedor', 'modalProveedor');
    enviarAjax('#modalunidad form', '{% url 'apl:producto:crear_unidad_ajax' %} ', '#id_unidad', 'modalunidad');

    // --- Función para mostrar mensajes dinámicos ---
    function mostrarMensaje(tipo, texto) {
        const msgDiv = $(`<div class="message ${tipo}">${texto}</div>`);
        $('#messages-container').append(msgDiv);
        setTimeout(() => msgDiv.fadeOut(500, () => msgDiv.remove()), 3000);
    }

    // --- Funciones de modal ---
    window.abrirModal = function(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'block';
        modal.offsetHeight;
        modal.style.opacity = '1';
    };

    window.cerrarModal = function(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.opacity = '0';
        setTimeout(() => { modal.style.display = 'none'; }, 300);
    };
});
</script>
{% endblock %}
<!--- hasta aqui formulario_crear_producto.html -->