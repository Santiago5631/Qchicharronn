{% load static %}
{% load permisos_tags %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Q' Chicharron{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" href="{% static 'imagenes/favicon.png' %}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <!-- Select2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <!-- TUS CSS -->
    <link rel="stylesheet" href="{% static 'lib/css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'lib/css/navbar.css' %}">
    <link rel="stylesheet" href="{% static 'lib/css/modales-select2.css' %}">

    {% block css_plugins %}{% endblock %}
</head>

<body>

{% include 'dashboard/aside/sidebar.html' %}

<div class="main-content">
    {% include 'dashboard/header.html' %}
    <div class="page-content">
        {% block content %}{% endblock %}
    </div>
</div>

{% include 'dashboard/footer.html' %}

<!-- ============================= -->
<!-- 1. LIBRERÍAS BASE             -->
<!-- ============================= -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="{% static 'lib/vendor/sweetalert2/sweetalert2.all.min.js' %}"></script>

<!-- Scripts del sistema -->
<script src="{% static 'lib/js/sidebar.js' %}"></script>
<script src="{% static 'lib/js/navbar.js' %}"></script>
<script src="{% static 'lib/js/sienna.js' %}"></script>
<script src="{% static 'lib/js/modales.js' %}"></script>

<!-- ============================= -->
<!-- 2. PLUGINS EXTRA POR PÁGINA   -->
<!-- ============================= -->
{% block js_plugins %}{% endblock %}

<!-- ============================= -->
<!-- 3. INICIALIZACIONES GLOBALES  -->
<!-- ============================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {

    /* SELECT2 GLOBAL */
    if ($.fn.select2) {
        $('.select2').select2({ width: '100%', language: "es" });
    }

    /* DATATABLE GLOBAL */
    if ($.fn.DataTable) {
        $('.datatable').DataTable({
            language: {
                lengthMenu:   "Mostrar _MENU_ registros por página",
                zeroRecords:  "No se encontraron resultados",
                info:         "Mostrando página _PAGE_ de _PAGES_",
                infoEmpty:    "No hay registros disponibles",
                infoFiltered: "(filtrado de _MAX_ registros totales)",
                search:       "Buscar:",
                paginate: {
                    first:    "Primero",
                    last:     "Último",
                    next:     "Siguiente",
                    previous: "Anterior"
                }
            },
            pageLength: 10,
            responsive: true,
            autoWidth: false
        });
    }

});

/* SWEETALERT DELETE GLOBAL */
$(document).on("click", ".btn-delete", function (e) {
    e.preventDefault();
    let url  = $(this).data("url");
    let name = $(this).data("name");

    Swal.fire({
        title: "¿Eliminar registro?",
        html: `
            <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                <div style="
                    width:64px; height:64px; border-radius:50%;
                    background:#fff5f5; display:flex;
                    align-items:center; justify-content:center;
                    margin-bottom:4px;">
                    <i class="bi bi-trash3-fill" style="font-size:28px; color:#e53e3e;"></i>
                </div>
                <p style="margin:0; color:#4a5568; font-size:15px;">
                    Se eliminará <strong style="color:#2d3748;">"${name}"</strong>
                </p>
                <p style="margin:0; color:#a0aec0; font-size:13px;">Esta acción no se puede deshacer.</p>
            </div>
        `,
        showCancelButton: true,
        confirmButtonColor: "#e53e3e",
        cancelButtonColor: "#a0aec0",
        confirmButtonText: '<i class="bi bi-trash3-fill me-1"></i> Sí, eliminar',
        cancelButtonText: "Cancelar",
        customClass: {
            popup: 'swal-delete-popup',
            title: 'swal-delete-title',
        },
        didOpen: () => {
            // ocultar el ícono por defecto de SweetAlert ya que usamos el nuestro
            const icon = Swal.getIcon();
            if (icon) icon.style.display = 'none';
        }
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: url,
                type: "POST",
                data: { csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val() },
                success: function (response) {
                    if (response.status === "ok") {
                        Swal.fire({
                            html: `
                                <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                                    <div style="
                                        width:64px; height:64px; border-radius:50%;
                                        background:#f0fff4; display:flex;
                                        align-items:center; justify-content:center;
                                        margin-bottom:4px;">
                                        <i class="bi bi-check-lg" style="font-size:28px; color:#38a169;"></i>
                                    </div>
                                    <p style="margin:0; font-weight:700; font-size:18px; color:#2d3748;">¡Eliminado!</p>
                                    <p style="margin:0; color:#718096; font-size:14px;">"${name}" fue eliminado correctamente.</p>
                                </div>
                            `,
                            showConfirmButton: false,
                            timer: 2000,
                            didOpen: () => {
                                const icon = Swal.getIcon();
                                if (icon) icon.style.display = 'none';
                            }
                        }).then(() => {
                            location.reload();
                        });
                            title: "¡Eliminado!",
                            text: `"${name}" fue eliminado correctamente.`,
                            icon: "success",
                            confirmButtonColor: "#1cc88a"
                        }).then(() => { location.reload(); });
                    }
                },
                error: function () {
                    Swal.fire({
                        html: `
                            <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                                <div style="
                                    width:64px; height:64px; border-radius:50%;
                                    background:#fff5f5; display:flex;
                                    align-items:center; justify-content:center;
                                    margin-bottom:4px;">
                                    <i class="bi bi-x-lg" style="font-size:28px; color:#e53e3e;"></i>
                                </div>
                                <p style="margin:0; font-weight:700; font-size:18px; color:#2d3748;">Error</p>
                                <p style="margin:0; color:#718096; font-size:14px;">No se pudo eliminar el registro.</p>
                            </div>
                        `,
                        showConfirmButton: true,
                        confirmButtonColor: "#e53e3e",
                        didOpen: () => {
                            const icon = Swal.getIcon();
                            if (icon) icon.style.display = 'none';
                        }
                    });
                    Swal.fire({ title: "Error", text: "No se pudo eliminar el registro", icon: "error" });
                }
            });
        }
    });
});
</script>

<!-- ============================= -->
<!-- 4. JS PERSONALIZADO POR PÁGINA-->
<!-- Se ejecuta DESPUÉS de todo    -->
<!-- ============================= -->
{% block js_custom %}{% endblock %}
{% block js_init %}{% endblock %}

<!-- ============================= -->
<!-- 5. MENSAJES DE DJANGO         -->
<!-- ============================= -->
{% if messages %}
<script>
{% for message in messages %}
Swal.fire({
    title: "{% if message.tags == 'success' %}Éxito{% elif message.tags == 'error' %}Error{% else %}Aviso{% endif %}",
    text: "{{ message|escapejs }}",
    icon: "{{ message.tags }}",
    showConfirmButton: false,
    timer: 3000
});
{% endfor %}
</script>
{% endif %}

</body>
</html>